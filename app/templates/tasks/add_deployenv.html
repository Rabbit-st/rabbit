<!DOCTYPE html>
<html class="x-admin-sm">
    
    <head>
        <meta charset="UTF-8">
        <title>添加收件人</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <link rel="stylesheet" href="/static/css/font.css">
        <link rel="stylesheet" href="/static/css/xadmin.css">
        <link rel="stylesheet" href="/static/codemirror/codemirror.css">
        <link rel="stylesheet" href="/static/codemirror/theme/base16-dark.css">
        <link rel="stylesheet" href="/static/mycss/my.css">
        <script type="text/javascript" src="/static/js/xadmin.js"></script>
        <script async src="/static/js/my/main.js" charset="utf-8"></script>
        <script async src="/static/js/custom/checkToken.js" charset="utf-8"></script>
        <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
        <!--[if lt IE 9]>
            <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
            <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body class='index-alert'>
        <div class="layui-fluid">
            <div class="layui-row">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <button class="layui-btn layui-btn-primary" style="border:none" 
                                onclick="javascript:history.back(-1);" onmouseover="show_back(this)" 
                                onmouseout="dis_back(this)"><i class="layui-icon">&#xe603</i></button>
                        <span>新建</span>
                    </div>
                    <div class="layui-card-body layui-form-body layui-table-main">
                        <form class="layui-form" id="mailconfig">
                          <div class="layui-form-item">
                              <label for="L_name" class="layui-form-label">
                                  <span class="x-red">*</span>名称
                              </label>
                              <div class="layui-input-inline" style="width: 30%">
                                  <input type="text" id="L_name" name="name" required="" lay-verify="required"
                                  autocomplete="off" class="layui-input">
                              </div>
                          </div>
                          <div class="layui-form-item">
                              <label for="L_classifying" class="layui-form-label">
                                  <span class="x-red"></span>标签
                              </label>
                              <div class="layui-input-inline" style="width: 30%">
                                  <input type="text" id="L_classifying" name="classifying" required="" lay-verify=""
                                  autocomplete="off" class="layui-input">
                              </div>
                          </div>
                          <div class="layui-form-item">
                              <label for="L_description" class="layui-form-label">
                                  <span class="x-red">*</span>备注
                              </label>
                              <div class="layui-input-inline" style="width: 30%">
                                <textarea id="L_description" name="description" autocomplete="off" class="layui-textarea"></textarea>
                              </div>
                          </div>
                          <div class="layui-form-item">
                              <label for="L_version" class="layui-form-label">
                                  <span class="x-red"></span>版本
                              </label>
                              <div class="layui-input-inline" style="width: 30%">
                                  <input type="text" id="L_version" name="version" required="" lay-verify="required"
                                  autocomplete="off" class="layui-input">
                              </div>
                          </div>
                          <div class="layui-form-item">
                              <label for="L_comment" class="layui-form-label">
                                  <span class="x-red">*</span>脚本内容
                              </label>
                              <div class="layui-input-block">
                                <div class="layui-tab">
                                    <ul class="layui-tab-title">
                                        <li class="layui-this" lay-id="1">python</li>
                                        <li lay-id="2">shell</li>
                                        <li lay-id="3">已上传脚本</li>
                                    </ul>
                                    <div class="layui-tab-content">
                                        <div class="layui-tab-item layui-show">
                                            <button type="button" class="layui-btn layui-btn-primary layui-btn-xs" id="script_python" name="scripts">上传文件</button><br>
                                            <textarea id="L_comment_python" name="comment_python" autocomplete="off" class="layui-textarea" lay-verify="cmd"></textarea>
                                        </div>
                                        <div class="layui-tab-item">
                                            <button type="button" class="layui-btn layui-btn-primary layui-btn-xs" id="script_shell" name="scripts">上传文件</button><br>
                                            <textarea id="L_comment_shell" name="comment_shell" autocomplete="off" class="layui-textarea" lay-verify="cmd"></textarea>
                                        </div>
                                        <div class="layui-tab-item">
                                            <div style="display:inline-block;padding:9px 15px;">
                                                <label><span class="x-red">*</span>脚本文件名</label>
                                            </div>
                                            <div style="display:inline-block;width:30%;">
                                            <input type="text" id="L_filename" name="scripts_filename" lay-verify="cmd"
                                              autocomplete="off" class="layui-input">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                              </div>
                          </div>
                          <div class="layui-form-item">
                              <label for="L_option" class="layui-form-label">
                                  <span class="x-red"></span>参数传递方式
                              </label>
                              <div class="layui-input-inline" style="width: 30%">
                                  <select name="parameter_mode" lay-verify=''>
                                    <option value="1">命令行顺序</option>
                                    <option value="2">JSON</option>
                                  </select>
                              </div>
                          </div>
                          <div class="layui-form-item">
                              <label for="L_options" class="layui-form-label">
                                  <span class="x-red"></span>参数
                              </label>
                              <div class="layui-input-inline">
                                  <button type="button" class="layui-btn layui-btn-radius layui-btn-primary" id="add_options">
                                      添加参数
                                      <i class="layui-icon layui-icon-down layui-font-12"></i>
                                  </button>    
                              </div>
                          </div>
                          <div class="layui-form-item" id="options">
                          </div>
                          <div class="layui-form-item">
                              <label for="L_submit" class="layui-form-label">
                              </label>
                              <button  class="layui-btn" lay-submit lay-filter="add">
                                    添加
                              </button>
                          </div>
                      </form>
                </div>
            </div>
        </div>
        <script type="text/javascript" src="/static/codemirror/codemirror.js"></script>
        <script type="text/javascript" src="/static/codemirror/mode/python/python.js"></script>
        <script type="text/javascript" src="/static/codemirror/mode/shell/shell.js"></script>
        <script type="text/javascript" src="/static/js/webtoolkit-base64.js"></script>
        <script type="text/javascript" src="/static/lib/layui/layui.js" charset="utf-8"></script>
        <script>layui.use(['form', 'layer', 'laydate', 'jquery', 'upload','dropdown'],
            function() {
                var $ = layui.jquery,
                layer = layui.layer,
                form = layui.form,
                laydate = layui.laydate,
                upload = layui.upload,
                dropdown = layui.dropdown,
                add_num = 1;
                
                form.verify({
                    cmd: function(value) {
                        var value;
                        value=$('#L_filename').val();
                        if(editor_py.getValue() === undefined || editor_py.getValue().length === 0){
                            if(editor_sh.getValue() === undefined || editor_sh.getValue().length === 0){
                                    if(value.length === 0)
                                        return "脚本内容为空";
                                }
                        }
                    }
                })
                upload.render({
                    elem: '#script_python'
                    ,url: ''
                    ,auto: false
                    ,accept: 'file'
                    ,exts: 'py'
                    ,choose: function(obj){
                        //读取文件
                        obj.preview(function (index, file, result){
                            // 里面定义的变量，外部无法使用
                            var txt = result.replace(/^data:text\/\w+;base64,/, "").replace(/^data:application\/\w+\-\w+;base64,/,"");
                            var udata = Base64.decode(txt);
                            if (udata !== undefined && udata.length > 0){
                                // 多次选择同一个文件，不会替换文本内容。
                                insertTextAtCuror(editor_py, udata);
                            }
                        });
                    }
                });
                upload.render({
                    elem: '#script_shell'
                    ,url: ''
                    ,auto: false
                    ,accept: 'file'
                    ,exts: 'sh'
                    ,choose: function(obj){
                        var data='';
                        //读取文件
                        obj.preview(function (index, file, result){
                            var txt = result.replace(/^data:text\/\w+;base64,/, "").replace(
                                            /^data:application\/\w+\-\w+;base64,/,"").replace(
                                            /^data:text\/\w+\-\w+;base64,/,"");
                            var udata = Base64.decode(txt);
                            if (udata !== undefined && udata.length > 0){
                                insertTextAtCuror(editor_sh, udata);
                            }
                        });
                    }
                });
                // 添加参数
                dropdown.render({
                    elem: '#add_options'
                    ,data: [{
                        title: '字符参数'
                        ,id: 1
                    },{
                        title: '选项参数'
                        ,id: 2
                    }]
                    ,id: "add_options"
                    ,click: function(data){
                        var ops_text;
                        add_parameter($, data.id, add_num);
                        add_num+=1;
                    }
                });

                //监听提交
                form.on('submit(add)', function(data) {
                    //console.log(data.field);
                    //console.log(editor_py.getValue());
                   // console.log(editor_sh.getValue());
                   if(editor_py.getValue() !== undefined && editor_py.getValue().length > 0){
                        data.field.lang = 'python';
                        data.field.cmd_comment = editor_py.getValue();
                   }else if(editor_sh.getValue() !== undefined && editor_sh.getValue().length > 0){
                        data.field.lang = 'shell';
                        data.field.cmd_comment = editor_sh.getValue();
                    }else{
                        data.field.lang = 'file';
                        data.field.cmd_comment = data.field.scripts_filename;
                    }
                    console.log(data.field);
                  $.ajax({
                    url: '/api/tasks/scripts',
                    type: 'post',
                    headers: {"Authorization": 'Bearer ' + getToken()},
                    data: JSON.stringify(data.field),
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    success:function(res){
                        layer.alert("添加成功", {
                            icon: 6
                        }, function() {
                            // console.log('success');
                            // 关闭当前frame
                            xadmin.close();

                            // 对父窗口进行刷新
                            xadmin.father_reload();
                        });
                    },
                    error: function(res){
                        error_message(res);
                    }
                  });
                  return false;
                });
            });
      function show_underline(obj){
            obj.style.textDecoration='underline';
      }
      function dis_underline(obj){
            obj.style.textDecoration='none';
      }
      function show_back(obj){
        obj.style.backgroundColor='#ECECEC';
      }
      function dis_back(obj){
        obj.style.backgroundColor='#FFF';
      };
      function insertTextAtCuror(editor, text){
        var doc = editor.getDoc();
        var cursor = doc.getCursor();
        doc.setValue(text);
//        doc.replaceRange(text);
      }
      var editor_py = CodeMirror.fromTextArea(document.getElementById('L_comment_python'),{
            mode: 'text/x-python',
            lineNumbers: true, // 显示行数
            indentUnit: 4, // 缩进单位为4
            matchBrackets : true,
            autofocus: true,
            styleActiveLine: true, // 当前行背景高亮
            lineWrapping: false, // 自动换行
            theme: 'base16-dark', // 显示类型
        });
      var editor_sh = CodeMirror.fromTextArea(document.getElementById('L_comment_shell'),{
            mode: 'text/x-shell',
            lineNumbers: true, // 显示行数
            indentUnit: 4, // 缩进单位为4
            matchBrackets : true,
            autofocus: true,
            styleActiveLine: true, // 当前行背景高亮
            lineWrapping: false, // 自动换行
            theme: 'base16-dark', // 显示类型
        });
      </script>
    </body>

</html>
